version: '3.8'

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    environment:
      # REQUIRED: Generate with: openssl rand -hex 32
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      
      # Database
      - DB_TYPE=sqlite
      
      # Domain configuration
      - N8N_HOST=n8n.haigent.ai
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://n8n.haigent.ai/
      - N8N_EDITOR_BASE_URL=https://n8n.haigent.ai/
      
      # Security
      - N8N_SECURE_COOKIE=true
      
      # Timezone
      - GENERIC_TIMEZONE=Asia/Karachi
      
    volumes:
      - n8n_data:/home/node/.n8n
      
    networks:
      - coolify
      
    labels:
      # Enable Traefik routing
      - "traefik.enable=true"
      
      # HTTP Router - Redirects HTTP to HTTPS
      - "traefik.http.routers.n8n-http.rule=Host(`n8n.haigent.ai`)"
      - "traefik.http.routers.n8n-http.entrypoints=http"
      - "traefik.http.routers.n8n-http.middlewares=n8n-redirect"
      
      # HTTPS Router - Main secure router
      - "traefik.http.routers.n8n-https.rule=Host(`n8n.haigent.ai`)"
      - "traefik.http.routers.n8n-https.entrypoints=https"
      - "traefik.http.routers.n8n-https.tls=true"
      - "traefik.http.routers.n8n-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.n8n-https.service=n8n"
      
      # Service - Tell Traefik which port n8n uses
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
      
      # Middleware - HTTP to HTTPS redirect
      - "traefik.http.middlewares.n8n-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.n8n-redirect.redirectscheme.permanent=true"
      
      # Headers for proper proxying
      - "traefik.http.middlewares.n8n-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.n8n-headers.headers.customrequestheaders.X-Forwarded-Host=n8n.haigent.ai"
      - "traefik.http.routers.n8n-https.middlewares=n8n-headers"
      
      # Coolify management labels
      - "coolify.managed=true"

volumes:
  n8n_data:
    driver: local

networks:
  coolify:
    external: true
    name: coolify